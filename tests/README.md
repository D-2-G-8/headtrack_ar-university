# Тесты для headtrack_ar

Этот каталог содержит полный набор тестов для модуля headtrack_ar.

## Структура тестов

### Базовые тесты (`test_basic.py`)
- Тесты функций отрисовки (overlay)
- Тесты структур данных (HeadInfo, FrameInfo)
- Тесты конфигурации (TrackerConfig, OverlayConfig)
- Тесты инициализации трекера

### Тесты детектора (`test_detector.py`)
- Инициализация детектора
- Детекция на различных типах кадров
- Вычисление точки на лбу
- Различные конфигурации детектора
- Тесты на различных разрешениях
- Тесты с различной яркостью и поворотами

### Тесты видео-источника (`test_video_source.py`)
- Инициализация с камерой и файлом
- Чтение кадров
- Управление разрешением
- Контекстный менеджер
- Освобождение ресурсов
- Обработка конца файла

### Интеграционные тесты (`test_integration.py`)
- Полный цикл обработки видео
- Работа с overlay и без него
- Сглаживание координат
- Обработка нескольких лиц
- Обработка пустых кадров
- Контекстный менеджер для трекера

### Тесты производительности (`test_performance.py`)
- Производительность детектора на одном кадре
- Производительность обработки кадров трекером
- End-to-end производительность
- Производительность на различных разрешениях
- Сравнение с/без сглаживания
- Тесты использования памяти
- Тесты стабильности при длительной работе

### Тесты различных условий (`test_conditions.py`)
- **Условия освещения:**
  - Яркое освещение
  - Тусклое освещение
  - Очень тусклое освещение
  - Нормальное освещение
  - Диапазон уровней яркости
  - Симуляция комнатного освещения

- **Углы поворота:**
  - Фронтальное лицо (0°)
  - Небольшой поворот (±15°)
  - Умеренный поворот (±30-45°)
  - Сильный поворот (±60-70°)
  - Диапазон углов поворота

- **Комбинированные условия:**
  - Тусклое освещение + поворот
  - Яркое освещение + поворот
  - Экстремальные условия

- **Реальные сценарии:**
  - Симуляция движения головы
  - Временная потеря лица
  - Несколько лиц одновременно

### Тесты обработки ошибок (`test_error_handling.py`)
- Обработка None и пустых входных данных
- Некорректные формы массивов
- Очень большие и очень маленькие кадры
- Повторные вызовы
- Неверные пути к файлам
- Чтение после освобождения ресурсов
- Исключения в детекторе
- Некорректные данные голов
- Обработка ошибок в overlay
- Экстремальные конфигурации

## Утилиты для тестов (`test_utils.py`)

Вспомогательные функции для создания тестовых данных:
- `create_synthetic_frame_with_face()` - создание синтетического кадра с лицом
- `create_test_video_file()` - создание временного видеофайла
- `create_frame_with_rotation()` - поворот кадра
- `adjust_brightness()` - изменение яркости
- `create_empty_frame()` - создание пустого кадра
- `cleanup_test_video()` - удаление тестового видео

## Запуск тестов

### Запуск всех тестов

```bash
# Из корня проекта
python -m pytest tests/

# Или используя unittest
python -m unittest discover -s tests -p "test_*.py"

# Или используя скрипт
python tests/run_all_tests.py
```

### Запуск конкретного набора тестов

```bash
# Базовые тесты
python -m unittest tests.test_basic

# Тесты детектора
python -m unittest tests.test_detector

# Интеграционные тесты
python -m unittest tests.test_integration

# Тесты производительности
python -m unittest tests.test_performance

# Тесты условий
python -m unittest tests.test_conditions

# Тесты обработки ошибок
python -m unittest tests.test_error_handling

# Или используя скрипт
python tests/run_all_tests.py basic
python tests/run_all_tests.py performance
```

### Запуск с подробным выводом

```bash
python -m unittest discover -s tests -p "test_*.py" -v
```

## Требования

Все тесты требуют установленных зависимостей проекта:
- opencv-python
- mediapipe
- numpy

Некоторые тесты могут требовать доступную камеру (тесты видео-источника с камерой пропускаются, если камера недоступна).

## Примечания

1. **Тесты производительности** могут занимать больше времени, так как они измеряют реальную производительность системы.

2. **Тесты с реальной камерой** автоматически пропускаются, если камера недоступна.

3. **Синтетические данные**: многие тесты используют синтетические кадры, которые могут не детектироваться MediaPipe так же хорошо, как реальные лица. Это нормально - тесты проверяют, что код не падает, а не качество детекции на синтетических данных.

4. **Временные файлы**: тесты создают временные видеофайлы в системной временной директории, которые автоматически удаляются после тестов.

## Покрытие кода

Для проверки покрытия кода тестами можно использовать `coverage`:

```bash
pip install coverage
coverage run -m unittest discover -s tests -p "test_*.py"
coverage report
coverage html  # Генерирует HTML отчет
```

## Добавление новых тестов

При добавлении новых функций в проект:

1. Добавьте unit-тесты в соответствующий файл (или создайте новый)
2. Добавьте интеграционные тесты, если функция влияет на основной цикл
3. Добавьте тесты производительности для критичных по скорости функций
4. Добавьте тесты обработки ошибок для новых путей выполнения кода
